<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì•¼ê°€ë‹¤</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;700&display=swap');

  :root {
    --bg: #f5f0e8;
    --fg: #1a1a1a;
    --accent: #e63946;
    --muted: #9e9e9e;
    --card: #ffffff;
    --border: #e0d9ce;
    --green: #2ecc71;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--fg);
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
  }

  h1 {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 2.8rem;
    letter-spacing: -1px;
    color: var(--fg);
  }

  .screen {
    display: none;
    width: 100%;
    max-width: 480px;
    min-height: 100vh;
    flex-direction: column;
    align-items: center;
    padding: 40px 24px;
  }
  .screen.active { display: flex; }

  #home { justify-content: center; gap: 28px; text-align: center; }

  .logo-shapes { display: flex; gap: 14px; justify-content: center; }
  .logo-shape { width: 36px; height: 36px; animation: float 2s ease-in-out infinite; }
  .logo-shape:nth-child(2) { animation-delay: 0.25s; }
  .logo-shape:nth-child(3) { animation-delay: 0.5s; }
  .logo-shape:nth-child(4) { animation-delay: 0.75s; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

  .subtitle { font-size: 0.85rem; color: var(--muted); letter-spacing: 3px; text-transform: uppercase; }

  .btn-group { display: flex; flex-direction: column; gap: 10px; width: 100%; }

  .btn {
    padding: 15px 24px;
    border: 2px solid var(--fg);
    background: var(--fg);
    color: var(--bg);
    font-family: 'Black Han Sans', sans-serif;
    font-size: 1.05rem;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 1px;
  }
  .btn:active { transform: scale(0.97); }
  .btn:hover { background: var(--accent); border-color: var(--accent); }
  .btn.outline { background: transparent; color: var(--fg); }
  .btn.outline:hover { background: var(--fg); color: var(--bg); }

  #tutorial { gap: 20px; }
  .tutorial-step {
    width: 100%; background: var(--card); border: 2px solid var(--border);
    padding: 18px; display: flex; gap: 14px; align-items: flex-start;
  }
  .step-num { font-family: 'Black Han Sans', sans-serif; font-size: 1.8rem; color: var(--accent); line-height: 1; min-width: 36px; }
  .step-content h3 { font-size: 0.95rem; font-weight: 700; margin-bottom: 4px; }
  .step-content p { font-size: 0.82rem; color: var(--muted); line-height: 1.6; }

  #game { padding: 16px 14px; gap: 10px; }

  .game-header { width: 100%; display: flex; justify-content: space-between; align-items: flex-start; }
  .stage-info { font-family: 'Black Han Sans', sans-serif; font-size: 1.3rem; }
  .count-display { font-family: 'Black Han Sans', sans-serif; font-size: 1.1rem; text-align: right; }
  .count-sub { font-size: 0.7rem; color: var(--muted); text-align: right; }

  .progress-bar { width: 100%; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--accent); transition: width 0.25s ease; border-radius: 3px; }
  .progress-label { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); margin-top: 3px; }

  .stage-map { width: 100%; display: flex; flex-wrap: wrap; gap: 3px; }
  .stage-dot { width: 9px; height: 9px; border-radius: 2px; background: var(--border); }
  .stage-dot.done { background: var(--accent); }
  .stage-dot.current { background: var(--fg); }

  .target-shape-area {
    width: 100%; background: var(--card); border: 2px solid var(--border);
    padding: 12px 16px; display: flex; align-items: center; gap: 14px;
  }
  .target-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }
  .target-shape-name { font-family: 'Black Han Sans', sans-serif; font-size: 1.3rem; margin-top: 2px; }
  #target-shape-svg { width: 52px; height: 52px; flex-shrink: 0; }

  .draw-hint { font-size: 0.75rem; color: var(--muted); text-align: center; letter-spacing: 1px; animation: blink 1.8s ease-in-out infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .canvas-wrap { width: 100%; border: 2px solid var(--border); background: var(--card); cursor: crosshair; touch-action: none; position: relative; }
  #draw-canvas { display: block; width: 100%; }
  .canvas-overlay {
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
    pointer-events: none; font-family: 'Black Han Sans', sans-serif; font-size: 3rem; opacity: 0; transition: opacity 0.1s;
  }
  .canvas-overlay.show { opacity: 1; }
  .canvas-overlay.ok { color: var(--green); }
  .canvas-overlay.fail { color: var(--accent); }

  .game-stats { width: 100%; display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--muted); }
  .sim-value { font-family: 'Black Han Sans', sans-serif; color: var(--fg); font-size: 0.95rem; }

  .back-btn { font-size: 0.78rem; color: var(--muted); background: none; border: none; cursor: pointer; letter-spacing: 1px; text-transform: uppercase; padding: 6px; margin-top: 2px; }
  .back-btn:hover { color: var(--fg); }

  #result { justify-content: center; gap: 18px; text-align: center; }
  .result-stage { font-family: 'Black Han Sans', sans-serif; font-size: 5rem; color: var(--accent); line-height: 1; }
  .nickname-input {
    width: 100%; padding: 14px 16px; border: 2px solid var(--fg);
    background: transparent; font-family: 'Noto Sans KR', sans-serif; font-size: 1rem; outline: none; text-align: center;
  }
  .nickname-input:focus { border-color: var(--accent); }

  #ranking { gap: 16px; }
  .rank-tabs { display: flex; width: 100%; border: 2px solid var(--fg); }
  .rank-tab {
    flex: 1; padding: 11px; text-align: center; font-family: 'Black Han Sans', sans-serif;
    font-size: 0.9rem; cursor: pointer; background: transparent; border: none; letter-spacing: 1px; transition: all 0.15s;
  }
  .rank-tab.active { background: var(--fg); color: var(--bg); }

  .week-label { font-size: 0.72rem; color: var(--muted); text-align: center; letter-spacing: 1px; }

  .rank-list { width: 100%; display: flex; flex-direction: column; gap: 5px; }
  .rank-item { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--card); border: 2px solid var(--border); }
  .rank-item.top1 { border-color: #f4c542; }
  .rank-item.top2 { border-color: #b0b0b0; }
  .rank-item.top3 { border-color: #cd7f32; }

  .rank-num { font-family: 'Black Han Sans', sans-serif; font-size: 1.2rem; min-width: 28px; color: var(--muted); }
  .rank-item.top1 .rank-num { color: #f4c542; }
  .rank-item.top2 .rank-num { color: #b0b0b0; }
  .rank-item.top3 .rank-num { color: #cd7f32; }

  .rank-info { flex: 1; }
  .rank-name { font-weight: 700; font-size: 0.92rem; }
  .rank-detail { font-size: 0.7rem; color: var(--muted); margin-top: 1px; }

  .rank-stage-badge { font-family: 'Black Han Sans', sans-serif; font-size: 0.9rem; color: var(--accent); text-align: right; }
  .rank-stage-badge span { display: block; font-family: 'Noto Sans KR', sans-serif; font-size: 0.65rem; color: var(--muted); font-weight: 400; }

  .empty-rank { text-align: center; color: var(--muted); font-size: 0.88rem; padding: 40px 16px; line-height: 1.8; }

  .flash-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 999; opacity: 0; }
  @keyframes flashAnim { 0%{opacity:1} 100%{opacity:0} }
  .flash-overlay.good { background: rgba(46,204,113,0.22); animation: flashAnim 0.35s ease; }
  .flash-overlay.bad { background: rgba(230,57,70,0.22); animation: flashAnim 0.35s ease; }
</style>
</head>
<body>

<div class="flash-overlay" id="flash"></div>

<!-- HOME -->
<div class="screen active" id="home">
  <div class="logo-shapes">
    <svg class="logo-shape" viewBox="0 0 36 36"><circle cx="18" cy="18" r="15" fill="#1a1a1a"/></svg>
    <svg class="logo-shape" viewBox="0 0 36 36"><polygon points="18,3 33,30 3,30" fill="#e63946"/></svg>
    <svg class="logo-shape" viewBox="0 0 36 36"><rect x="3" y="3" width="30" height="30" fill="#1a1a1a"/></svg>
    <svg class="logo-shape" viewBox="0 0 36 36"><polygon points="18,2 22,13 34,13 25,20 28,32 18,25 8,32 11,20 2,13 14,13" fill="#e63946"/></svg>
  </div>
  <h1>ì•¼ê°€ë‹¤</h1>
  <p class="subtitle">ë„í˜• ê·¸ë¦¬ê¸° ê²Œì„</p>
  <div class="btn-group" style="margin-top:8px;">
    <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    <button class="btn outline" onclick="showScreen('tutorial')">íŠœí† ë¦¬ì–¼</button>
    <button class="btn outline" onclick="showRanking()">ğŸ† ì£¼ê°„ ë­í‚¹</button>
  </div>
  <p style="font-size:0.72rem; color:var(--muted); margin-top:20px;">ì´ 50ìŠ¤í…Œì´ì§€ Â· ìµœëŒ€ 100ë§Œ ê°œê¹Œì§€</p>
</div>

<!-- TUTORIAL -->
<div class="screen" id="tutorial">
  <div style="text-align:center; margin-bottom:8px;">
    <h1>ì•¼ê°€ë‹¤</h1>
    <p class="subtitle" style="margin-top:4px;">ì´ë ‡ê²Œ í•˜ë©´ ë¼ìš”</p>
  </div>
  <div class="tutorial-step">
    <div class="step-num">1</div>
    <div class="step-content"><h3>ë„í˜• í™•ì¸</h3><p>ìƒë‹¨ì— ê·¸ë ¤ì•¼ í•  ë„í˜•ì´ í‘œì‹œë¼ìš”. â—‹ â–³ â–¡ â˜… ì¤‘ í•˜ë‚˜ì˜ˆìš”.</p></div>
  </div>
  <div class="tutorial-step">
    <div class="step-num">2</div>
    <div class="step-content"><h3>ê·¸ë¦¬ê¸°</h3><p>ìº”ë²„ìŠ¤ì— ì†ê°€ë½ì´ë‚˜ ë§ˆìš°ìŠ¤ë¡œ ë„í˜•ì„ ê·¸ë¦¬ì„¸ìš”. ì†ì„ ë–¼ë©´ ìë™ìœ¼ë¡œ ì±„ì ë¼ìš”!</p></div>
  </div>
  <div class="tutorial-step">
    <div class="step-num">3</div>
    <div class="step-content"><h3>ë‹¨ê³„ í´ë¦¬ì–´</h3><p>ëª©í‘œ ê°œìˆ˜ë§Œí¼ í†µê³¼í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ! ì´ 50ìŠ¤í…Œì´ì§€, ê°ˆìˆ˜ë¡ ë” ë§ì´ ê·¸ë ¤ì•¼ í•´ìš”.</p></div>
  </div>
  <div class="tutorial-step">
    <div class="step-num">4</div>
    <div class="step-content"><h3>ì£¼ê°„ ë­í‚¹</h3><p>ì´ë²ˆ ì£¼ ê¸°ë¡ì´ ë­í‚¹ì— ì˜¬ë¼ê°€ìš”. ë§¤ì£¼ ì›”ìš”ì¼ë§ˆë‹¤ ìƒˆë¡œ ì‹œì‘!</p></div>
  </div>
  <div class="btn-group" style="margin-top:8px;">
    <button class="btn" onclick="startGame()">ì‹œì‘í•˜ê¸°!</button>
    <button class="btn outline" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <div class="game-header">
    <div>
      <div class="stage-info">STAGE <span id="stage-num">1</span> <span style="font-size:0.8rem;color:var(--muted);">/ 50</span></div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:2px;">ëª©í‘œ: <span id="target-count">3</span>ê°œ</div>
    </div>
    <div>
      <div class="count-display"><span id="done-count">0</span> / <span id="need-count">3</span></div>
      <div class="count-sub">ì™„ë£Œ</div>
    </div>
  </div>

  <div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="progress-label">
      <span id="progress-pct">0%</span>
      <span>í†µê³¼: <b id="pass-count">0</b></span>
    </div>
  </div>

  <div class="stage-map" id="stage-map"></div>

  <div class="target-shape-area">
    <div style="flex:1">
      <div class="target-label">ì§€ê¸ˆ ê·¸ë ¤ì•¼ í•  ë„í˜•</div>
      <div class="target-shape-name" id="shape-name">ë™ê·¸ë¼ë¯¸</div>
    </div>
    <svg id="target-shape-svg" viewBox="0 0 52 52" width="52" height="52"></svg>
  </div>

  <div class="draw-hint">âœï¸ ê·¸ë¦¬ë©´ ìë™ ì±„ì !</div>

  <div class="canvas-wrap" id="canvas-wrap">
    <canvas id="draw-canvas" height="260"></canvas>
    <div class="canvas-overlay" id="canvas-overlay"></div>
  </div>

  <div class="game-stats">
    <div>ìœ ì‚¬ë„: <span class="sim-value" id="sim-val">â€“</span></div>
    <div>ì´ ì‹œë„: <b id="total-drawn">0</b></div>
  </div>

  <button class="back-btn" onclick="confirmQuit()">ê·¸ë§Œí•˜ê¸°</button>
</div>

<!-- RESULT -->
<div class="screen" id="result">
  <p class="subtitle">ê²Œì„ ì¢…ë£Œ</p>
  <h1>ì•¼ê°€ë‹¤</h1>
  <div style="margin:12px 0;">
    <div style="font-size:0.82rem;color:var(--muted);">ë„ë‹¬í•œ ìŠ¤í…Œì´ì§€</div>
    <div class="result-stage" id="result-stage">â€“</div>
    <div style="font-size:0.82rem;color:var(--muted);margin-top:6px;">ì´ <span id="result-total" style="font-weight:700;color:var(--fg);">0</span>ê°œ ê·¸ë¦¼</div>
  </div>
  <p style="font-size:0.82rem;color:var(--muted);">ë‹‰ë„¤ì„ ì…ë ¥ í›„ ì£¼ê°„ ë­í‚¹ì— ë“±ë¡!</p>
  <input class="nickname-input" id="nickname-input" type="text" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ì)" maxlength="8">
  <div class="btn-group">
    <button class="btn" onclick="saveRanking()">ğŸ† ë­í‚¹ ë“±ë¡</button>
    <button class="btn outline" onclick="startGame()">ë‹¤ì‹œ í•˜ê¸°</button>
    <button class="btn outline" onclick="showScreen('home')">í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<!-- RANKING -->
<div class="screen" id="ranking">
  <h1>ì•¼ê°€ë‹¤</h1>
  <div class="rank-tabs">
    <button class="rank-tab active" id="tab-week" onclick="switchTab('week')">ì´ë²ˆ ì£¼ ğŸ”¥</button>
    <button class="rank-tab" id="tab-all" onclick="switchTab('all')">ì „ì²´ ê¸°ë¡</button>
  </div>
  <div class="week-label" id="week-label"></div>
  <div class="rank-list" id="rank-list"><div class="empty-rank">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
  <div class="btn-group" style="margin-top:4px;">
    <button class="btn" onclick="startGame()">ë„ì „í•˜ê¸°</button>
    <button class="btn outline" onclick="showScreen('home')">í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<script>
const SHAPES = ['circle','triangle','rect','star'];
const SHAPE_NAMES = {circle:'ë™ê·¸ë¼ë¯¸', triangle:'ì„¸ëª¨', rect:'ë„¤ëª¨', star:'ë³„'};
const TOTAL_STAGES = 50;
const STAGE_TARGETS = [
  3,5,7,10,13,
  16,20,25,30,40,
  50,65,80,100,120,
  150,180,220,270,330,
  400,480,570,680,800,
  950,1200,1500,1900,2400,
  3000,3800,4800,6000,7500,
  9500,12000,16000,21000,28000,
  37000,50000,65000,85000,115000,
  155000,220000,350000,600000,1000000
];

function getTarget(s) { return STAGE_TARGETS[Math.min(s-1, STAGE_TARGETS.length-1)]; }

let currentStage=1, currentShape='circle', doneCount=0, totalDrawn=0, targetCount=3, passCount=0;
let isDrawing=false, points=[], submitLocked=false, currentRankingTab='week';

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startGame() {
  currentStage=1; doneCount=0; totalDrawn=0; passCount=0;
  targetCount=getTarget(1);
  pickShape(); updateGameUI(); clearCanvas();
  showScreen('game');
}

function pickShape() {
  currentShape = SHAPES[Math.floor(Math.random()*SHAPES.length)];
  document.getElementById('shape-name').textContent = SHAPE_NAMES[currentShape];
  document.getElementById('target-shape-svg').innerHTML = shapeToSVG(currentShape, 52);
}

function shapeToSVG(shape, size) {
  const h = size/2;
  if (shape==='circle') return `<circle cx="${h}" cy="${h}" r="${h*.74}" fill="none" stroke="#1a1a1a" stroke-width="3"/>`;
  if (shape==='triangle') return `<polygon points="${h},${h*.18} ${h*1.82},${h*1.82} ${h*.18},${h*1.82}" fill="none" stroke="#e63946" stroke-width="3"/>`;
  if (shape==='rect') return `<rect x="${h*.18}" y="${h*.18}" width="${h*1.64}" height="${h*1.64}" fill="none" stroke="#1a1a1a" stroke-width="3"/>`;
  if (shape==='star') {
    let pts=[];
    for(let i=0;i<10;i++){const a=(i*Math.PI/5)-Math.PI/2;const r=i%2===0?h*.76:h*.3;pts.push(`${h+r*Math.cos(a)},${h+r*Math.sin(a)}`);}
    return `<polygon points="${pts.join(' ')}" fill="none" stroke="#e63946" stroke-width="3"/>`;
  }
}

function updateGameUI() {
  document.getElementById('stage-num').textContent = currentStage;
  document.getElementById('target-count').textContent = targetCount.toLocaleString();
  document.getElementById('done-count').textContent = doneCount.toLocaleString();
  document.getElementById('need-count').textContent = targetCount.toLocaleString();
  document.getElementById('pass-count').textContent = passCount;
  document.getElementById('total-drawn').textContent = totalDrawn;
  const pct = Math.min(doneCount/targetCount*100,100);
  document.getElementById('progress-fill').style.width = pct+'%';
  document.getElementById('progress-pct').textContent = Math.round(pct)+'%';
  const map = document.getElementById('stage-map');
  map.innerHTML = '';
  for(let i=1;i<=TOTAL_STAGES;i++){
    const d=document.createElement('div');
    d.className='stage-dot'+(i<currentStage?' done':i===currentStage?' current':'');
    map.appendChild(d);
  }
}

// CANVAS
const canvas = document.getElementById('draw-canvas');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  const wrap = document.getElementById('canvas-wrap');
  const w = wrap.clientWidth;
  if(canvas.width!==w){canvas.width=w; canvas.height=260;}
}

function clearCanvas() {
  resizeCanvas();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  points=[];
  document.getElementById('sim-val').textContent='â€“';
  document.getElementById('canvas-overlay').className='canvas-overlay';
}

function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const sx=canvas.width/rect.width, sy=canvas.height/rect.height;
  if(e.touches&&e.touches.length>0) return {x:(e.touches[0].clientX-rect.left)*sx, y:(e.touches[0].clientY-rect.top)*sy};
  if(e.changedTouches&&e.changedTouches.length>0) return {x:(e.changedTouches[0].clientX-rect.left)*sx, y:(e.changedTouches[0].clientY-rect.top)*sy};
  return {x:(e.clientX-rect.left)*sx, y:(e.clientY-rect.top)*sy};
}

function startStroke(e) {
  if(submitLocked) return;
  isDrawing=true; points=[];
  ctx.clearRect(0,0,canvas.width,canvas.height);
  document.getElementById('canvas-overlay').className='canvas-overlay';
  const p=getPos(e); points.push(p);
  ctx.beginPath(); ctx.moveTo(p.x,p.y);
  ctx.strokeStyle='#1a1a1a'; ctx.lineWidth=3; ctx.lineCap='round'; ctx.lineJoin='round';
}

function continueStroke(e) {
  if(!isDrawing) return;
  const p=getPos(e); points.push(p);
  ctx.lineTo(p.x,p.y); ctx.stroke();
}

function endStroke() {
  if(!isDrawing) return;
  isDrawing=false;
  if(points.length<5) return;
  submitLocked=true;
  setTimeout(()=>{submitDrawing(); submitLocked=false;}, 180);
}

canvas.addEventListener('mousedown', e=>{e.preventDefault();startStroke(e);});
canvas.addEventListener('mousemove', e=>{continueStroke(e);});
canvas.addEventListener('mouseup', e=>{e.preventDefault();endStroke();});
canvas.addEventListener('mouseleave', ()=>{if(isDrawing)endStroke();});
canvas.addEventListener('touchstart', e=>{e.preventDefault();startStroke(e);},{passive:false});
canvas.addEventListener('touchmove', e=>{e.preventDefault();continueStroke(e);},{passive:false});
canvas.addEventListener('touchend', e=>{e.preventDefault();endStroke();},{passive:false});

// SIMILARITY
function calcSim() {
  if(points.length<5) return 0;
  const xs=points.map(p=>p.x), ys=points.map(p=>p.y);
  const minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys);
  const w=maxX-minX,h=maxY-minY;
  if(w<10||h<10) return 0;
  const norm=points.map(p=>({x:(p.x-minX)/w,y:(p.y-minY)/h}));
  const closed=()=>{const s=norm[0],e=norm[norm.length-1];return Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2)<0.38;};
  if(currentShape==='circle'){
    const ratio=Math.min(w,h)/Math.max(w,h);
    if(ratio<0.35) return 15;
    const cx=0.5,cy=0.5;
    const dists=norm.map(p=>Math.sqrt((p.x-cx)**2+(p.y-cy)**2));
    const avg=dists.reduce((a,b)=>a+b,0)/dists.length;
    const variance=dists.map(d=>(d-avg)**2).reduce((a,b)=>a+b,0)/dists.length;
    return Math.min(100,Math.round(Math.max(0,100-variance*500)*ratio*(closed()?1:0.55)));
  }
  if(currentShape==='triangle'){
    let changes=0,lastDir=null;
    for(let i=1;i<norm.length;i++){
      const dx=norm[i].x-norm[i-1].x,dy=norm[i].y-norm[i-1].y;
      const angle=Math.atan2(dy,dx);
      if(lastDir!==null){let d=Math.abs(angle-lastDir);if(d>Math.PI)d=2*Math.PI-d;if(d>0.75)changes++;}
      lastDir=angle;
    }
    return Math.min(100,(changes>=2&&changes<=7?45:15)+(closed()?30:0)+25);
  }
  if(currentShape==='rect'){
    const near=norm.filter(p=>Math.min(p.x,1-p.x,p.y,1-p.y)<0.22).length/norm.length;
    return Math.min(100,Math.round(near*70)+(closed()?30:0));
  }
  if(currentShape==='star'){
    const dists=norm.map(p=>Math.sqrt((p.x-.5)**2+(p.y-.5)**2));
    let peaks=0;
    for(let i=1;i<dists.length-1;i++) if(dists[i]>dists[i-1]&&dists[i]>dists[i+1]&&dists[i]>0.22)peaks++;
    return Math.min(100,Math.min(peaks*14,65)+(closed()?35:0));
  }
  return 50;
}

function submitDrawing() {
  if(points.length<5) return;
  const sim=calcSim();
  document.getElementById('sim-val').textContent=sim+'%';
  totalDrawn++;
  document.getElementById('total-drawn').textContent=totalDrawn;
  const ok=sim>=38;
  if(ok){doneCount++;passCount++;}
  const ov=document.getElementById('canvas-overlay');
  ov.textContent=ok?'âœ“':'âœ—';
  ov.className='canvas-overlay show '+(ok?'ok':'fail');
  setTimeout(()=>{ov.className='canvas-overlay';},500);
  const fl=document.getElementById('flash');
  fl.className='flash-overlay '+(ok?'good':'bad');
  setTimeout(()=>{fl.className='flash-overlay';},400);
  updateGameUI();
  setTimeout(()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height); points=[];
    if(doneCount>=targetCount){
      if(currentStage>=TOTAL_STAGES){setTimeout(()=>endGame(),400);}
      else{currentStage++;doneCount=0;targetCount=getTarget(currentStage);pickShape();updateGameUI();}
    }
  },500);
}

function endGame() {
  document.getElementById('result-stage').textContent=currentStage;
  document.getElementById('result-total').textContent=totalDrawn.toLocaleString();
  showScreen('result');
}

function confirmQuit() { if(confirm('ê²Œì„ì„ ê·¸ë§Œí• ê¹Œìš”?')) endGame(); }

// WEEK
function getWeekKey() {
  const now=new Date(), day=now.getDay();
  const diff=(day===0?-6:1)-day;
  const mon=new Date(now); mon.setDate(now.getDate()+diff);
  return `${mon.getFullYear()}-${String(mon.getMonth()+1).padStart(2,'0')}-${String(mon.getDate()).padStart(2,'0')}`;
}

function getWeekLabel() {
  const now=new Date(), day=now.getDay();
  const diff=(day===0?-6:1)-day;
  const mon=new Date(now); mon.setDate(now.getDate()+diff);
  const sun=new Date(mon); sun.setDate(mon.getDate()+6);
  const f=d=>`${d.getMonth()+1}/${d.getDate()}`;
  return `${f(mon)} ~ ${f(sun)} ì£¼ê°„ ë­í‚¹`;
}

async function saveRanking() {
  const name=document.getElementById('nickname-input').value.trim();
  if(!name){alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');return;}
  const entry={name,stage:currentStage,total:totalDrawn,date:new Date().toLocaleDateString('ko-KR'),week:getWeekKey()};
  try {
    const wKey=`yagada-week-${getWeekKey()}`;
    let weekly=[];
    try{const r=await window.storage.get(wKey,true);if(r)weekly=JSON.parse(r.value);}catch(e){}
    weekly.push(entry);
    weekly.sort((a,b)=>b.stage!==a.stage?b.stage-a.stage:b.total-a.total);
    weekly=weekly.slice(0,100);
    await window.storage.set(wKey,JSON.stringify(weekly),true);

    let all=[];
    try{const r=await window.storage.get('yagada-all',true);if(r)all=JSON.parse(r.value);}catch(e){}
    all.push(entry);
    all.sort((a,b)=>b.stage!==a.stage?b.stage-a.stage:b.total-a.total);
    all=all.slice(0,200);
    await window.storage.set('yagada-all',JSON.stringify(all),true);

    alert('ğŸ† ë­í‚¹ì— ë“±ë¡ëì–´ìš”!');
    showRanking();
  } catch(e){ alert('ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); }
}

async function showRanking() {
  showScreen('ranking');
  currentRankingTab='week';
  document.getElementById('tab-week').className='rank-tab active';
  document.getElementById('tab-all').className='rank-tab';
  document.getElementById('week-label').textContent=getWeekLabel();
  await loadRankTab('week');
}

async function switchTab(tab) {
  currentRankingTab=tab;
  document.getElementById('tab-week').className='rank-tab'+(tab==='week'?' active':'');
  document.getElementById('tab-all').className='rank-tab'+(tab==='all'?' active':'');
  document.getElementById('week-label').textContent=tab==='week'?getWeekLabel():'ì „ì²´ ê¸°ë¡ TOP 20';
  await loadRankTab(tab);
}

async function loadRankTab(tab) {
  const list=document.getElementById('rank-list');
  list.innerHTML='<div class="empty-rank">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    let rankings=[];
    const key=tab==='week'?`yagada-week-${getWeekKey()}`:'yagada-all';
    try{const r=await window.storage.get(key,true);if(r)rankings=JSON.parse(r.value);}catch(e){}
    if(rankings.length===0){
      list.innerHTML=`<div class="empty-rank">${tab==='week'?'ì´ë²ˆ ì£¼ ê¸°ë¡ì´ ì—†ì–´ìš”.<br>ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”! ğŸ”¥':'ì•„ì§ ì „ì²´ ê¸°ë¡ì´ ì—†ì–´ìš”!'}</div>`;
      return;
    }
    list.innerHTML=rankings.slice(0,20).map((r,i)=>{
      const cls=i===0?'top1':i===1?'top2':i===2?'top3':'';
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1);
      return `<div class="rank-item ${cls}">
        <div class="rank-num">${medal}</div>
        <div class="rank-info">
          <div class="rank-name">${r.name}</div>
          <div class="rank-detail">${r.date} Â· ${(r.total||0).toLocaleString()}ê°œ</div>
        </div>
        <div class="rank-stage-badge">STAGE ${r.stage}<span>/ ${TOTAL_STAGES}</span></div>
      </div>`;
    }).join('');
  } catch(e){ list.innerHTML='<div class="empty-rank">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”.</div>'; }
}

resizeCanvas();
window.addEventListener('resize',()=>{ if(document.getElementById('game').classList.contains('active')) resizeCanvas(); });
</script>
</body>
</html>
