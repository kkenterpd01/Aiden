<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ì•¼ê°€ë‹¤</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;700&display=swap');
:root {
  --bg:#f5f0e8; --fg:#1a1a1a; --acc:#e63946; --muted:#9e9e9e; --card:#fff; --border:#e0d9ce; --green:#2ecc71;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--fg);font-family:'Noto Sans KR',sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;}
h1{font-family:'Black Han Sans',sans-serif;font-size:2.8rem;letter-spacing:-1px;}
.screen{display:none;width:100%;max-width:480px;min-height:100vh;flex-direction:column;align-items:center;padding:36px 20px;}
.screen.active{display:flex;}
.sub{font-size:.82rem;color:var(--muted);letter-spacing:3px;text-transform:uppercase;}
.gap{display:flex;flex-direction:column;gap:10px;width:100%;}
.btn{padding:15px 24px;border:2px solid var(--fg);background:var(--fg);color:var(--bg);font-family:'Black Han Sans',sans-serif;font-size:1.05rem;cursor:pointer;transition:all .15s;letter-spacing:1px;}
.btn:active{transform:scale(.97);}
.btn:hover{background:var(--acc);border-color:var(--acc);}
.btn.out{background:transparent;color:var(--fg);}
.btn.out:hover{background:var(--fg);color:var(--bg);}
.btn.acc{background:var(--acc);border-color:var(--acc);}

/* ONBOARDING */
#ob{justify-content:center;gap:22px;text-align:center;}
.logos{display:flex;gap:14px;justify-content:center;}
.ls{width:40px;height:40px;animation:fl 2s ease-in-out infinite;}
.ls:nth-child(2){animation-delay:.25s}.ls:nth-child(3){animation-delay:.5s}.ls:nth-child(4){animation-delay:.75s}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.inp{width:100%;padding:15px;border:2px solid var(--fg);background:transparent;font-family:'Noto Sans KR',sans-serif;font-size:1rem;outline:none;text-align:center;}
.inp:focus{border-color:var(--acc);}
.inp::placeholder{color:var(--muted);}
.divider{width:100%;display:flex;align-items:center;gap:10px;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}
.divider span{font-size:.75rem;color:var(--muted);}
.sbtn{width:100%;padding:13px;border:2px solid var(--border);background:var(--card);font-family:'Noto Sans KR',sans-serif;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .15s;font-weight:700;}
.sbtn:hover{border-color:var(--fg);}
.sbtn.kakao{background:#FEE500;border-color:#FEE500;color:#3A1D1D;}
.sbtn.google{background:#fff;border-color:#ddd;}
.sbtn.apple{background:#000;border-color:#000;color:#fff;}
.skip{font-size:.78rem;color:var(--muted);background:none;border:none;cursor:pointer;text-decoration:underline;}

/* HOME */
#home{justify-content:center;gap:18px;text-align:center;}
.ubadge{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--card);border:2px solid var(--border);width:100%;justify-content:space-between;}
.uname{font-family:'Black Han Sans',sans-serif;font-size:1rem;}
.urank{font-size:.75rem;color:var(--acc);font-weight:700;}
.rules{width:100%;background:var(--card);border:2px solid var(--border);padding:14px 16px;text-align:left;}
.rt{font-family:'Black Han Sans',sans-serif;font-size:.88rem;margin-bottom:8px;letter-spacing:1px;}
.ri{display:flex;gap:8px;font-size:.78rem;color:var(--muted);line-height:1.5;margin-bottom:4px;}
.ri:last-child{margin-bottom:0;}
.rd{color:var(--acc);font-weight:700;flex-shrink:0;}

/* GAME */
#game{padding:14px;gap:8px;}
.gh{width:100%;display:flex;justify-content:space-between;align-items:flex-start;}
.si{font-family:'Black Han Sans',sans-serif;font-size:1.3rem;}
.cd{font-family:'Black Han Sans',sans-serif;font-size:1.1rem;text-align:right;}
.csub{font-size:.68rem;color:var(--muted);text-align:right;}
.pbar{width:100%;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.pfill{height:100%;background:var(--acc);transition:width .25s;border-radius:3px;}
.plabel{display:flex;justify-content:space-between;font-size:.68rem;color:var(--muted);margin-top:3px;}
.lrank{width:100%;background:var(--fg);color:var(--bg);padding:8px 14px;display:flex;justify-content:space-between;align-items:center;}
.lrl{font-size:.7rem;letter-spacing:1px;opacity:.7;}
.lrv{font-family:'Black Han Sans',sans-serif;font-size:1rem;color:#f4c542;}
.tbox{width:100%;background:var(--card);border:2px solid var(--border);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px;}
.tlabel{font-size:.68rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.tname{font-family:'Black Han Sans',sans-serif;font-size:2rem;margin-top:3px;}
#tsvg{width:88px;height:88px;flex-shrink:0;}
.hint{font-size:.73rem;color:var(--muted);text-align:center;animation:blink 1.8s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.cwrap{width:100%;border:2px solid var(--border);background:var(--card);touch-action:none;position:relative;cursor:crosshair;-webkit-user-select:none;user-select:none;}
#cv{display:block;width:100%;height:250px;touch-action:none;}
.cov{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;font-family:'Black Han Sans',sans-serif;font-size:3.5rem;opacity:0;transition:opacity .1s;}
.cov.show{opacity:1;}
.cov.ok{color:var(--green);}
.cov.fail{color:var(--acc);}
.gst{width:100%;display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);}
.sv{font-family:'Black Han Sans',sans-serif;color:var(--fg);font-size:.92rem;}
.td{font-family:'Black Han Sans',sans-serif;font-size:.92rem;color:var(--fg);}
.backbtn{font-size:.75rem;color:var(--muted);background:none;border:none;cursor:pointer;letter-spacing:1px;text-transform:uppercase;padding:4px;margin-top:2px;}
.backbtn:hover{color:var(--fg);}

/* RESULT */
#result{justify-content:center;gap:16px;text-align:center;}
.rs{font-family:'Black Han Sans',sans-serif;font-size:5rem;color:var(--acc);line-height:1;}
.rb{padding:10px 20px;background:var(--fg);color:var(--bg);font-family:'Black Han Sans',sans-serif;font-size:1.1rem;letter-spacing:2px;}

/* RANKING */
#ranking{gap:14px;}
.rtabs{display:flex;width:100%;border:2px solid var(--fg);}
.rtab{flex:1;padding:11px;text-align:center;font-family:'Black Han Sans',sans-serif;font-size:.88rem;cursor:pointer;background:transparent;border:none;letter-spacing:1px;transition:all .15s;}
.rtab.active{background:var(--fg);color:var(--bg);}
.wl{font-size:.7rem;color:var(--muted);text-align:center;letter-spacing:1px;}
.rlist{width:100%;display:flex;flex-direction:column;gap:5px;}
.ri2{display:flex;align-items:center;gap:10px;padding:11px 13px;background:var(--card);border:2px solid var(--border);}
.ri2.t1{border-color:#f4c542}.ri2.t2{border-color:#b0b0b0}.ri2.t3{border-color:#cd7f32}.ri2.me{border-color:var(--acc);background:#fff5f5;}
.rn{font-family:'Black Han Sans',sans-serif;font-size:1.1rem;min-width:26px;color:var(--muted);}
.ri2.t1 .rn{color:#f4c542}.ri2.t2 .rn{color:#b0b0b0}.ri2.t3 .rn{color:#cd7f32}.ri2.me .rn{color:var(--acc);}
.rinfo{flex:1;}
.rname{font-weight:700;font-size:.9rem;}
.rdet{font-size:.68rem;color:var(--muted);margin-top:1px;}
.rright{text-align:right;}
.rsbadge{font-family:'Black Han Sans',sans-serif;font-size:.88rem;color:var(--acc);}
.rtime{font-size:.68rem;color:var(--muted);margin-top:2px;}
.empty{text-align:center;color:var(--muted);font-size:.85rem;padding:36px 16px;line-height:1.9;}

/* TUTORIAL */
#tut{gap:18px;}
.tstep{width:100%;background:var(--card);border:2px solid var(--border);padding:16px;display:flex;gap:12px;}
.tsn{font-family:'Black Han Sans',sans-serif;font-size:1.8rem;color:var(--acc);line-height:1;min-width:34px;}
.tsc h3{font-size:.92rem;font-weight:700;margin-bottom:3px;}
.tsc p{font-size:.8rem;color:var(--muted);line-height:1.6;}

/* FLASH */
.flash{position:fixed;inset:0;pointer-events:none;z-index:999;opacity:0;}
@keyframes fa{0%{opacity:1}100%{opacity:0}}
.flash.good{background:rgba(46,204,113,.22);animation:fa .35s ease;}
.flash.bad{background:rgba(230,57,70,.22);animation:fa .35s ease;}
</style>
</head>
<body>
<div class="flash" id="flash"></div>

<!-- ONBOARDING -->
<div class="screen active" id="ob">
  <div class="logos">
    <svg class="ls" viewBox="0 0 40 40"><circle cx="20" cy="20" r="17" fill="#1a1a1a"/></svg>
    <svg class="ls" viewBox="0 0 40 40"><polygon points="20,3 37,34 3,34" fill="#e63946"/></svg>
    <svg class="ls" viewBox="0 0 40 40"><rect x="3" y="3" width="34" height="34" fill="#1a1a1a"/></svg>
    <svg class="ls" viewBox="0 0 40 40"><polygon points="20,2 24,14 37,14 27,21 31,34 20,26 9,34 13,21 3,14 16,14" fill="#e63946"/></svg>
  </div>
  <h1>ì•¼ê°€ë‹¤</h1>
  <p class="sub">ë„í˜• ê·¸ë¦¬ê¸° ê²Œì„</p>
  <div class="gap" style="margin-top:4px;">
    <p style="font-size:.82rem;color:var(--muted);text-align:center;">ë‹‰ë„¤ì„ì„ ì •í•´ì£¼ì„¸ìš”</p>
    <input class="inp" id="ob-nick" type="text" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ìµœëŒ€ 8ì)" maxlength="8">
    <button class="btn" onclick="startWithNick()">ì‹œì‘í•˜ê¸° â†’</button>
  </div>
  <div class="divider" style="margin-top:4px;"><span>ë˜ëŠ” ê°„í¸ ë¡œê·¸ì¸</span></div>
  <div class="gap">
    <button class="sbtn kakao" onclick="socialLogin('kakao')">
      <svg width="20" height="20" viewBox="0 0 40 40"><ellipse cx="20" cy="20" rx="20" ry="20" fill="#3A1D1D"/><path d="M20 8C13.37 8 8 12.27 8 17.5c0 3.36 2.19 6.31 5.5 8.04L12.5 30l5.1-3.38c.79.11 1.6.18 2.4.18 6.63 0 12-4.27 12-9.5S26.63 8 20 8z" fill="#FEE500"/></svg>
      ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘
    </button>
    <button class="sbtn google" onclick="socialLogin('google')">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.97 6.19C12.43 13.72 17.74 9.5 24 9.5z"/></svg>
      Googleë¡œ ì‹œì‘
    </button>
    <button class="sbtn apple" onclick="socialLogin('apple')">
      <svg width="18" height="18" viewBox="0 0 814 1000" fill="white"><path d="M788.1 340.9c-5.8 4.5-108.2 62.2-108.2 190.5 0 148.4 130.3 200.9 134.2 202.2-.6 3.2-20.7 71.9-68.7 141.9-42.8 61.6-87.5 123.1-155.5 123.1s-85.5-39.5-164-39.5c-76 0-103.7 40.8-165.9 40.8s-105-57.8-155.5-127.4C46 405.8 0 303.9 0 207.9 0 89.4 79.3 27.5 157.5 27.5c58 0 104.9 34.1 131.7 34.1 25.4 0 79.3-40.8 144.9-40.8 22.3 0 108.2 1.9 159.3 78.5zm-105.9 16.4C655.4 131 638 78.3 638 26.7 638 17.9 636.7 9 635.5.3c-5.2 2.6-14.4 7.5-21 12.9-40.3 33.6-70.4 85.2-70.4 135.5 0 8.5 1.3 17 2.6 25.6 5.2.7 11 1.9 16.2 1.9 47.1 0 90.2-28.4 112.3-65.4 4.5-7.8 7.1-19.4 7.1-25.6z"/></svg>
      Appleë¡œ ì‹œì‘
    </button>
  </div>
  <button class="skip" onclick="skipLogin()" style="margin-top:8px;">ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘</button>
</div>

<!-- HOME -->
<div class="screen" id="home">
  <div class="logos" style="margin-bottom:4px;">
    <svg class="ls" viewBox="0 0 40 40"><circle cx="20" cy="20" r="17" fill="#1a1a1a"/></svg>
    <svg class="ls" viewBox="0 0 40 40"><polygon points="20,3 37,34 3,34" fill="#e63946"/></svg>
    <svg class="ls" viewBox="0 0 40 40"><rect x="3" y="3" width="34" height="34" fill="#1a1a1a"/></svg>
    <svg class="ls" viewBox="0 0 40 40"><polygon points="20,2 24,14 37,14 27,21 31,34 20,26 9,34 13,21 3,14 16,14" fill="#e63946"/></svg>
  </div>
  <h1>ì•¼ê°€ë‹¤</h1>
  <p class="sub">ë„í˜• ê·¸ë¦¬ê¸° ê²Œì„</p>
  <div class="ubadge">
    <div><div style="font-size:.68rem;color:var(--muted);">í”Œë ˆì´ì–´</div><div class="uname" id="home-uname">â€“</div></div>
    <div class="urank" id="home-urank">ìˆœìœ„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
  <div class="rules">
    <div class="rt">ğŸ“‹ ê²Œì„ ê·œì¹™</div>
    <div class="ri"><span class="rd">â–¶</span><span>ë„í˜•ì„ ê·¸ë¦¬ë©´ ì†ì„ ë–¼ëŠ” ìˆœê°„ ìë™ ì±„ì </span></div>
    <div class="ri"><span class="rd">â–¶</span><span>ìŠ¤í…Œì´ì§€ë§ˆë‹¤ ëª©í‘œ ê°œìˆ˜ë¥¼ ì±„ìš°ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ!</span></div>
    <div class="ri"><span class="rd">â–¶</span><span>ê°™ì€ ìŠ¤í…Œì´ì§€ë¼ë©´ <b>ì§§ì€ ì‹œê°„</b>ìœ¼ë¡œ ë‹¬ì„±í•œ ì‚¬ëŒì´ ë” ë†’ì€ ìˆœìœ„</span></div>
    <div class="ri"><span class="rd">â–¶</span><span>ì£¼ê°„ ë­í‚¹ì€ ë§¤ì£¼ ì›”ìš”ì¼ ì´ˆê¸°í™”</span></div>
  </div>
  <div class="gap">
    <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    <button class="btn out" onclick="go('tut')">íŠœí† ë¦¬ì–¼</button>
    <button class="btn out" onclick="showRanking()">ğŸ† ì£¼ê°„ ë­í‚¹</button>
  </div>
  <div id="home-preview" style="width:100%;margin-top:4px;"></div>
</div>

<!-- TUTORIAL -->
<div class="screen" id="tut">
  <div style="text-align:center;margin-bottom:4px;"><h1>ì•¼ê°€ë‹¤</h1><p class="sub" style="margin-top:4px;">ì´ë ‡ê²Œ í•˜ë©´ ë¼ìš”</p></div>
  <div class="tstep"><div class="tsn">1</div><div class="tsc"><h3>ë„í˜• í™•ì¸</h3><p>ìƒë‹¨ì— ê·¸ë ¤ì•¼ í•  ë„í˜•ì´ í‘œì‹œë¼ìš”. â—‹ â–³ â–¡ â˜… ì¤‘ í•˜ë‚˜ì˜ˆìš”.</p></div></div>
  <div class="tstep"><div class="tsn">2</div><div class="tsc"><h3>ê·¸ë¦¬ê¸°</h3><p>ìº”ë²„ìŠ¤ì— ì†ê°€ë½ì´ë‚˜ ë§ˆìš°ìŠ¤ë¡œ ë„í˜•ì„ ê·¸ë¦¬ì„¸ìš”. ì†ì„ ë–¼ë©´ ìë™ìœ¼ë¡œ ì±„ì !</p></div></div>
  <div class="tstep"><div class="tsn">3</div><div class="tsc"><h3>ë‹¨ê³„ í´ë¦¬ì–´</h3><p>ëª©í‘œ ê°œìˆ˜ë¥¼ ì±„ìš°ë©´ ë‹¤ìŒ ìŠ¤í…Œì´ì§€! ì´ 50ìŠ¤í…Œì´ì§€.</p></div></div>
  <div class="tstep"><div class="tsn">4</div><div class="tsc"><h3>ìˆœìœ„ ê²½ìŸ</h3><p>ê°™ì€ ìŠ¤í…Œì´ì§€ë©´ <b>ë” ì§§ì€ ì‹œê°„</b>ìœ¼ë¡œ í´ë¦¬ì–´í•œ ì‚¬ëŒì´ ì´ê²¨ìš”!</p></div></div>
  <div class="gap" style="margin-top:4px;">
    <button class="btn" onclick="startGame()">ì‹œì‘í•˜ê¸°!</button>
    <button class="btn out" onclick="go('home')">ëŒì•„ê°€ê¸°</button>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <div class="gh">
    <div>
      <div class="si">STAGE <span id="g-stage">1</span><span style="font-size:.8rem;color:var(--muted);"> / 50</span></div>
      <div style="font-size:.68rem;color:var(--muted);margin-top:1px;">ëª©í‘œ: <span id="g-target">3</span>ê°œ</div>
    </div>
    <div>
      <div class="cd"><span id="g-done">0</span> / <span id="g-need">3</span></div>
      <div class="csub">ì™„ë£Œ</div>
    </div>
  </div>
  <div>
    <div class="pbar"><div class="pfill" id="g-pfill" style="width:0%"></div></div>
    <div class="plabel"><span id="g-ppct">0%</span><span>í†µê³¼: <b id="g-pass">0</b></span></div>
  </div>
  <div class="lrank">
    <span class="lrl">ğŸ”´ ì‹¤ì‹œê°„ ë‚´ ìˆœìœ„</span>
    <span class="lrv" id="g-lrank">â€“</span>
  </div>
  <div class="tbox">
    <div>
      <div class="tlabel">ì§€ê¸ˆ ê·¸ë ¤ì•¼ í•  ë„í˜•</div>
      <div class="tname" id="g-sname">ë™ê·¸ë¼ë¯¸</div>
    </div>
    <svg id="tsvg" viewBox="0 0 88 88"></svg>
  </div>
  <div class="hint">âœï¸ ê·¸ë¦¬ë©´ ìë™ ì±„ì !</div>
  <div class="cwrap" id="cwrap">
    <canvas id="cv" height="250"></canvas>
    <div class="cov" id="cov"></div>
  </div>
  <div class="gst">
    <div>ìœ ì‚¬ë„: <span class="sv" id="g-sim">â€“</span></div>
    <div>â± <span class="td" id="g-time">0:00</span></div>
  </div>
  <button class="backbtn" onclick="quitGame()">ê·¸ë§Œí•˜ê¸° â†’ í™ˆ</button>
</div>

<!-- RESULT -->
<div class="screen" id="result">
  <p class="sub">ê²Œì„ ì¢…ë£Œ</p>
  <h1>ì•¼ê°€ë‹¤</h1>
  <div style="margin:10px 0;display:flex;flex-direction:column;align-items:center;gap:6px;">
    <div style="font-size:.8rem;color:var(--muted);">ë„ë‹¬í•œ ìŠ¤í…Œì´ì§€</div>
    <div class="rs" id="r-stage">â€“</div>
    <div style="font-size:.8rem;color:var(--muted);">ì†Œìš” ì‹œê°„: <b id="r-time" style="color:var(--fg);">â€“</b></div>
    <div style="font-size:.8rem;color:var(--muted);">ì´ <span id="r-total" style="font-weight:700;color:var(--fg);">0</span>ê°œ ê·¸ë¦¼</div>
  </div>
  <div class="rb" id="r-rank">ìˆœìœ„ ê³„ì‚° ì¤‘...</div>
  <div class="gap" style="width:100%;">
    <button class="btn acc" onclick="saveAndRanking()">ğŸ† ë­í‚¹ ë“±ë¡ & í™•ì¸</button>
    <button class="btn out" onclick="startGame()">ë‹¤ì‹œ í•˜ê¸°</button>
    <button class="btn out" onclick="go('home')">í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<!-- RANKING -->
<div class="screen" id="ranking">
  <h1>ì•¼ê°€ë‹¤</h1>
  <div class="rtabs">
    <button class="rtab active" id="tab-w" onclick="switchTab('w')">ì´ë²ˆ ì£¼ ğŸ”¥</button>
    <button class="rtab" id="tab-a" onclick="switchTab('a')">ì „ì²´ ê¸°ë¡</button>
  </div>
  <div class="wl" id="r-wlabel"></div>
  <div class="rlist" id="rlist"><div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
  <div class="gap" style="margin-top:4px;">
    <button class="btn" onclick="startGame()">ë„ì „í•˜ê¸°</button>
    <button class="btn out" onclick="go('home')">í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<script>
// =====================
// CONSTANTS
// =====================
const SHAPES = ['circle','triangle','rect','star'];
const SNAMES = {circle:'ë™ê·¸ë¼ë¯¸', triangle:'ì„¸ëª¨', rect:'ë„¤ëª¨', star:'ë³„'};
const TOTAL = 50;
const TARGETS = [
  3,5,7,10,13,16,20,25,30,40,
  50,65,80,100,120,150,180,220,270,330,
  400,480,570,680,800,950,1200,1500,1900,2400,
  3000,3800,4800,6000,7500,9500,12000,16000,21000,28000,
  37000,50000,65000,85000,115000,155000,220000,350000,600000,1000000
];

// =====================
// STATE
// =====================
let uName = localStorage.getItem('yg-name') || '';
let curStage=1, curShape='circle', done=0, drawn=0, target=3, passed=0;
let drawing=false, pts=[], locked=false;
let gStart=0, timerInt=null, curTab='w';

const tgt = s => TARGETS[Math.min(s-1, TARGETS.length-1)];

// =====================
// SCREEN
// =====================
function go(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function init() {
  if(uName) { go('home'); refreshHome(); }
  else go('ob');
}

// =====================
// ONBOARDING
// =====================
function startWithNick() {
  const v = document.getElementById('ob-nick').value.trim();
  if(!v) { alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
  uName = v;
  localStorage.setItem('yg-name', uName);
  go('home'); refreshHome();
}
function socialLogin(type) {
  const v = document.getElementById('ob-nick').value.trim();
  if(!v) { alert('ë¨¼ì € ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
  uName = v;
  localStorage.setItem('yg-name', uName);
  const label = {kakao:'ì¹´ì¹´ì˜¤', google:'Google', apple:'Apple'}[type];
  alert(`${label} ë¡œê·¸ì¸ì€ ì•± ì¶œì‹œ í›„ ì§€ì› ì˜ˆì •ì´ì—ìš”!\nì§€ê¸ˆì€ ë‹‰ë„¤ì„ìœ¼ë¡œ ì‹œì‘í• ê²Œìš” ğŸ˜Š`);
  go('home'); refreshHome();
}
function skipLogin() {
  uName = 'ê²ŒìŠ¤íŠ¸_' + Math.floor(Math.random()*9000+1000);
  localStorage.setItem('yg-name', uName);
  go('home'); refreshHome();
}

// =====================
// HOME
// =====================
function refreshHome() {
  document.getElementById('home-uname').textContent = uName||'â€“';
  loadHomePreview();
}

async function loadHomePreview() {
  try {
    let weekly=[];
    try{const r=await window.storage.get('yg-w-'+wk(),true);if(r)weekly=JSON.parse(r.value);}catch(e){}
    const rankEl = document.getElementById('home-urank');
    const idx = weekly.findIndex(r=>r.name===uName);
    rankEl.textContent = idx>=0 ? `ì´ë²ˆ ì£¼ ${idx+1}ìœ„ ğŸ”¥` : 'ë­í‚¹ ì—†ìŒ';
    const el = document.getElementById('home-preview');
    if(!el) return;
    if(weekly.length===0){
      el.innerHTML='<p style="font-size:.72rem;color:var(--muted);text-align:center;padding:8px 0;">ì´ë²ˆ ì£¼ ê¸°ë¡ì´ ì—†ì–´ìš”!</p>';
      return;
    }
    el.innerHTML = '<div style="font-size:.68rem;color:var(--muted);letter-spacing:2px;text-align:center;margin-bottom:6px;text-transform:uppercase;">ì´ë²ˆ ì£¼ TOP 3</div>'
      + weekly.slice(0,3).map((r,i)=>{
        const m=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':'ğŸ¥‰';
        const me=r.name===uName;
        return `<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:${me?'#fff5f5':'#fff'};border:1.5px solid ${me?'#e63946':'#e0d9ce'};margin-bottom:4px;">
          <span>${m}</span>
          <span style="flex:1;font-weight:700;font-size:.85rem;">${r.name}${me?' ğŸ‘ˆ':''}</span>
          <span style="font-family:'Black Han Sans',sans-serif;color:#e63946;font-size:.82rem;">ST.${r.stage}</span>
          <span style="font-size:.68rem;color:#9e9e9e;">â±${ft(r.sec)}</span>
        </div>`;
      }).join('');
  } catch(e){}
}

// =====================
// GAME
// =====================
function startGame() {
  curStage=1; done=0; drawn=0; passed=0;
  target=tgt(1); gStart=Date.now();
  pickShape(); updateUI(); clearCv();
  startTimer(); go('game'); updateLiveRank();
}

function startTimer() {
  if(timerInt) clearInterval(timerInt);
  timerInt = setInterval(()=>{
    const e=Math.floor((Date.now()-gStart)/1000);
    document.getElementById('g-time').textContent=`${Math.floor(e/60)}:${String(e%60).padStart(2,'0')}`;
  },500);
}

function pickShape() {
  curShape = SHAPES[Math.floor(Math.random()*SHAPES.length)];
  document.getElementById('g-sname').textContent = SNAMES[curShape];
  document.getElementById('tsvg').innerHTML = makeSVG(curShape);
}

function makeSVG(s) {
  const h=44;
  if(s==='circle') return `<circle cx="${h}" cy="${h}" r="${h*.74}" fill="none" stroke="#1a1a1a" stroke-width="4" stroke-linecap="round"/>`;
  if(s==='triangle') return `<polygon points="${h},${h*.15} ${h*1.85},${h*1.85} ${h*.15},${h*1.85}" fill="none" stroke="#e63946" stroke-width="4" stroke-linejoin="round"/>`;
  if(s==='rect') return `<rect x="${h*.15}" y="${h*.15}" width="${h*1.7}" height="${h*1.7}" fill="none" stroke="#1a1a1a" stroke-width="4" stroke-linejoin="round"/>`;
  if(s==='star'){let p=[];for(let i=0;i<10;i++){const a=(i*Math.PI/5)-Math.PI/2;const r=i%2===0?h*.78:h*.32;p.push(`${h+r*Math.cos(a)},${h+r*Math.sin(a)}`);}return `<polygon points="${p.join(' ')}" fill="none" stroke="#e63946" stroke-width="4" stroke-linejoin="round"/>`;}
}

function updateUI() {
  document.getElementById('g-stage').textContent=curStage;
  document.getElementById('g-target').textContent=target.toLocaleString();
  document.getElementById('g-done').textContent=done.toLocaleString();
  document.getElementById('g-need').textContent=target.toLocaleString();
  document.getElementById('g-pass').textContent=passed;
  const p=Math.min(done/target*100,100);
  document.getElementById('g-pfill').style.width=p+'%';
  document.getElementById('g-ppct').textContent=Math.round(p)+'%';
}

async function updateLiveRank() {
  try {
    let weekly=[];
    try{const r=await window.storage.get('yg-w-'+wk(),true);if(r)weekly=JSON.parse(r.value);}catch(e){}
    const elapsed=(Date.now()-gStart)/1000;
    let rank=1;
    for(const r of weekly){
      if(r.stage>curStage) rank++;
      else if(r.stage===curStage&&r.sec<elapsed) rank++;
    }
    document.getElementById('g-lrank').textContent=`${rank}ìœ„ / ${weekly.length+1}ëª…`;
  } catch(e){}
}

function quitGame() {
  clearInterval(timerInt);
  go('home');
  refreshHome();
}

// =====================
// CANVAS
// =====================
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

function resizeCv() {
  const wrap = document.getElementById('cwrap');
  cv.width = wrap.clientWidth || 320;
  cv.height = 250;
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 4;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
}

function clearCv() {
  resizeCv();
  ctx.clearRect(0,0,cv.width,cv.height);
  pts=[];
  document.getElementById('g-sim').textContent='â€“';
  document.getElementById('cov').className='cov';
}

function getXY(e) {
  const r=cv.getBoundingClientRect();
  const sx=cv.width/r.width, sy=cv.height/r.height;
  const src = e.touches ? e.touches[0] : e.changedTouches ? e.changedTouches[0] : e;
  return {x:(src.clientX-r.left)*sx, y:(src.clientY-r.top)*sy};
}

// ì „ì²´ í¬ì¸íŠ¸ë¥¼ ë§¤ë²ˆ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ë°©ì‹ - ì„ ì´ ë°˜ë“œì‹œ ë³´ì„
function redraw() {
  ctx.clearRect(0,0,cv.width,cv.height);
  if(pts.length < 2) return;
  ctx.save();
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 4;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.globalAlpha = 1.0;
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
  ctx.stroke();
  ctx.restore();
}

cv.addEventListener('mousedown', e=>{
  if(locked) return;
  e.preventDefault();
  drawing=true; pts=[];
  document.getElementById('cov').className='cov';
  const p=getXY(e);
  pts.push(p);
  // ì¦‰ì‹œ ì  í•˜ë‚˜ ê·¸ë ¤ì„œ ì‘ë‹µ í™•ì¸
  ctx.save();
  ctx.fillStyle='#1a1a1a';
  ctx.beginPath();
  ctx.arc(p.x,p.y,3,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
});
cv.addEventListener('mousemove', e=>{
  if(!drawing) return;
  pts.push(getXY(e));
  redraw();
});
cv.addEventListener('mouseup', e=>{
  if(!drawing) return;
  e.preventDefault();
  drawing=false;
  if(pts.length<10) return;
  locked=true;
  setTimeout(()=>{ judge(); locked=false; },200);
});
cv.addEventListener('mouseleave', ()=>{ if(drawing){ drawing=false; if(pts.length>=10){ locked=true; setTimeout(()=>{ judge(); locked=false; },200); } } });

cv.addEventListener('touchstart', e=>{
  if(locked) return;
  e.preventDefault();
  drawing=true; pts=[];
  document.getElementById('cov').className='cov';
  const p=getXY(e);
  pts.push(p);
  ctx.save();
  ctx.fillStyle='#1a1a1a';
  ctx.beginPath();
  ctx.arc(p.x,p.y,3,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
},{passive:false});
cv.addEventListener('touchmove', e=>{
  if(!drawing) return;
  e.preventDefault();
  pts.push(getXY(e));
  redraw();
},{passive:false});
cv.addEventListener('touchend', e=>{
  if(!drawing) return;
  e.preventDefault();
  drawing=false;
  if(pts.length<10) return;
  locked=true;
  setTimeout(()=>{ judge(); locked=false; },200);
},{passive:false});

// =====================
// SIMILARITY
// =====================
function sim() {
  if(pts.length < 10) return 0;
  const xs=pts.map(p=>p.x), ys=pts.map(p=>p.y);
  const x0=Math.min(...xs), x1=Math.max(...xs);
  const y0=Math.min(...ys), y1=Math.max(...ys);
  const w=x1-x0, h=y1-y0;
  if(w<20||h<20) return 0;

  const N=pts.map(p=>({x:(p.x-x0)/w, y:(p.y-y0)/h}));

  // ë‹«í˜: ì‹œì‘~ë ê±°ë¦¬
  const closeDist = Math.sqrt((N[0].x-N[N.length-1].x)**2+(N[0].y-N[N.length-1].y)**2);
  const closed = closeDist < 0.45;

  if(curShape==='circle') {
    // ì¤‘ì‹¬ ê³„ì‚°
    const cx=N.reduce((s,p)=>s+p.x,0)/N.length;
    const cy=N.reduce((s,p)=>s+p.y,0)/N.length;
    // ì¤‘ì‹¬ì—ì„œ ê±°ë¦¬ ê· ì¼ì„±
    const ds=N.map(p=>Math.sqrt((p.x-cx)**2+(p.y-cy)**2));
    const avg=ds.reduce((a,b)=>a+b,0)/ds.length;
    const variance=ds.map(d=>(d-avg)**2).reduce((a,b)=>a+b,0)/ds.length;
    // ë¹„ìœ¨
    const ratio=Math.min(w,h)/Math.max(w,h);
    let score = Math.max(0,1-variance*6) * ratio * 100;
    if(closed) score = Math.min(100, score*1.15);
    return Math.round(Math.min(100,score));
  }

  if(curShape==='triangle') {
    // ë°©í–¥ ì „í™˜ íšŸìˆ˜
    let turns=0, prev=null;
    for(let i=2;i<N.length;i++){
      const dx=N[i].x-N[i-2].x, dy=N[i].y-N[i-2].y;
      if(Math.abs(dx)<.004&&Math.abs(dy)<.004) continue;
      const a=Math.atan2(dy,dx);
      if(prev!==null){let d=Math.abs(a-prev);if(d>Math.PI)d=2*Math.PI-d;if(d>.7)turns++;}
      prev=a;
    }
    let score=25;
    if(turns>=1&&turns<=8) score=60+Math.min(turns,2)*10;
    if(closed) score=Math.min(100,score+20);
    return score;
  }

  if(curShape==='rect') {
    const edge=N.filter(p=>Math.min(p.x,1-p.x)<.22||Math.min(p.y,1-p.y)<.22).length/N.length;
    let score=Math.round(edge*75);
    if(closed) score=Math.min(100,score+25);
    return score;
  }

  if(curShape==='star') {
    // ê¸‰ê²©í•œ ë°©í–¥ì „í™˜
    let sharp=0, prev=null;
    for(let i=1;i<N.length;i++){
      const dx=N[i].x-N[i-1].x, dy=N[i].y-N[i-1].y;
      if(Math.abs(dx)<.004&&Math.abs(dy)<.004) continue;
      const a=Math.atan2(dy,dx);
      if(prev!==null){let d=Math.abs(a-prev);if(d>Math.PI)d=2*Math.PI-d;if(d>0.9)sharp++;}
      prev=a;
    }
    if(sharp>=3) return Math.min(100,40+sharp*7);
    return sharp*12;
  }
  return 50;
}

function judge() {
  const s=sim();
  document.getElementById('g-sim').textContent=s+'%';
  drawn++;
  const ok=s>=35;
  if(ok){done++;passed++;}
  const ov=document.getElementById('cov');
  ov.textContent=ok?'âœ“':'âœ—';
  ov.className='cov show '+(ok?'ok':'fail');
  setTimeout(()=>ov.className='cov',500);
  const fl=document.getElementById('flash');
  fl.className='flash '+(ok?'good':'bad');
  setTimeout(()=>fl.className='flash',380);
  updateUI();
  updateLiveRank();
  setTimeout(()=>{
    ctx.clearRect(0,0,cv.width,cv.height); pts=[];
    if(done>=target){
      if(curStage>=TOTAL){ clearInterval(timerInt); setTimeout(endGame,400); }
      else{ curStage++; done=0; target=tgt(curStage); pickShape(); updateUI(); }
    }
  },500);
}

function endGame() {
  clearInterval(timerInt);
  const elapsed=Math.floor((Date.now()-gStart)/1000);
  const m=Math.floor(elapsed/60),s=elapsed%60;
  document.getElementById('r-stage').textContent=curStage;
  document.getElementById('r-time').textContent=`${m}ë¶„ ${s}ì´ˆ`;
  document.getElementById('r-total').textContent=drawn.toLocaleString();
  calcRank(curStage,elapsed);
  go('result');
}

async function calcRank(stage,elapsed){
  try{
    let w=[];
    try{const r=await window.storage.get('yg-w-'+wk(),true);if(r)w=JSON.parse(r.value);}catch(e){}
    let rank=1;
    for(const r of w){if(r.stage>stage)rank++;else if(r.stage===stage&&r.sec<elapsed)rank++;}
    document.getElementById('r-rank').textContent=`ì´ë²ˆ ì£¼ ì˜ˆìƒ ìˆœìœ„ ${rank}ìœ„ / ${w.length+1}ëª…`;
  }catch(e){document.getElementById('r-rank').textContent='ìˆœìœ„ ê³„ì‚° ë¶ˆê°€';}
}

// =====================
// RANKING
// =====================
function wk(){
  const n=new Date(),d=n.getDay(),diff=(d===0?-6:1)-d;
  const m=new Date(n);m.setDate(n.getDate()+diff);
  return `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}-${String(m.getDate()).padStart(2,'0')}`;
}
function wkLabel(){
  const n=new Date(),d=n.getDay(),diff=(d===0?-6:1)-d;
  const m=new Date(n);m.setDate(n.getDate()+diff);
  const s=new Date(m);s.setDate(m.getDate()+6);
  const f=x=>`${x.getMonth()+1}/${x.getDate()}`;
  return `${f(m)} ~ ${f(s)} ì£¼ê°„ ë­í‚¹`;
}
function ft(sec){
  if(sec==null)return'â€“';
  return `${Math.floor(sec/60)}ë¶„${String(sec%60).padStart(2,'0')}ì´ˆ`;
}

async function saveAndRanking(){
  const elapsed=Math.floor((Date.now()-gStart)/1000);
  const entry={name:uName,stage:curStage,total:drawn,sec:elapsed,date:new Date().toLocaleDateString('ko-KR'),week:wk()};
  try{
    const key='yg-w-'+wk();
    let weekly=[];
    try{const r=await window.storage.get(key,true);if(r)weekly=JSON.parse(r.value);}catch(e){}
    weekly.push(entry);
    weekly.sort((a,b)=>b.stage!==a.stage?b.stage-a.stage:a.sec-b.sec);
    weekly=weekly.slice(0,100);
    await window.storage.set(key,JSON.stringify(weekly),true);
    let all=[];
    try{const r=await window.storage.get('yg-all',true);if(r)all=JSON.parse(r.value);}catch(e){}
    all.push(entry);
    all.sort((a,b)=>b.stage!==a.stage?b.stage-a.stage:a.sec-b.sec);
    all=all.slice(0,200);
    await window.storage.set('yg-all',JSON.stringify(all),true);
    showRanking();
  }catch(e){showRanking();}
}

async function showRanking(){
  go('ranking');
  curTab='w';
  document.getElementById('tab-w').className='rtab active';
  document.getElementById('tab-a').className='rtab';
  document.getElementById('r-wlabel').textContent=wkLabel();
  await loadTab('w');
}

async function switchTab(t){
  curTab=t;
  document.getElementById('tab-w').className='rtab'+(t==='w'?' active':'');
  document.getElementById('tab-a').className='rtab'+(t==='a'?' active':'');
  document.getElementById('r-wlabel').textContent=t==='w'?wkLabel():'ì „ì²´ ê¸°ë¡ TOP 20';
  await loadTab(t);
}

async function loadTab(t){
  const list=document.getElementById('rlist');
  list.innerHTML='<div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try{
    let data=[];
    const key=t==='w'?'yg-w-'+wk():'yg-all';
    try{const r=await window.storage.get(key,true);if(r)data=JSON.parse(r.value);}catch(e){}
    if(data.length===0){
      list.innerHTML=`<div class="empty">${t==='w'?'ì´ë²ˆ ì£¼ ê¸°ë¡ì´ ì—†ì–´ìš”.<br>ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”! ğŸ”¥':'ì•„ì§ ì „ì²´ ê¸°ë¡ì´ ì—†ì–´ìš”!'}</div>`;
      return;
    }
    list.innerHTML=data.slice(0,20).map((r,i)=>{
      const cls=i===0?'t1':i===1?'t2':i===2?'t3':r.name===uName?'me':'';
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1);
      const me=r.name===uName;
      return `<div class="ri2 ${cls}">
        <div class="rn">${medal}</div>
        <div class="rinfo">
          <div class="rname">${r.name}${me?' ğŸ‘ˆ':''}</div>
          <div class="rdet">${r.date} Â· ${(r.total||0).toLocaleString()}ê°œ</div>
        </div>
        <div class="rright">
          <div class="rsbadge">STAGE ${r.stage}</div>
          <div class="rtime">â± ${ft(r.sec)}</div>
        </div>
      </div>`;
    }).join('');
  }catch(e){list.innerHTML='<div class="empty">ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”.</div>';}
}

// =====================
// INIT
// =====================
resizeCv();
window.addEventListener('resize',()=>{ if(document.getElementById('game').classList.contains('active')) resizeCv(); });
init();
</script>
</body>
</html>
