<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì•¼ê°€ë‹¤</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;700&display=swap');

  :root {
    --bg: #f5f0e8;
    --fg: #1a1a1a;
    --accent: #e63946;
    --muted: #9e9e9e;
    --card: #ffffff;
    --border: #e0d9ce;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--fg);
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
  }

  h1 {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 2.8rem;
    letter-spacing: -1px;
    color: var(--fg);
  }

  /* ===== SCREENS ===== */
  .screen {
    display: none;
    width: 100%;
    max-width: 480px;
    min-height: 100vh;
    flex-direction: column;
    align-items: center;
    padding: 40px 24px;
  }
  .screen.active { display: flex; }

  /* ===== HOME ===== */
  #home {
    justify-content: center;
    gap: 32px;
    text-align: center;
  }

  .logo-shapes {
    display: flex;
    gap: 14px;
    justify-content: center;
    margin-bottom: 8px;
  }

  .logo-shape {
    width: 36px;
    height: 36px;
    animation: float 2s ease-in-out infinite;
  }
  .logo-shape:nth-child(2) { animation-delay: 0.3s; }
  .logo-shape:nth-child(3) { animation-delay: 0.6s; }
  .logo-shape:nth-child(4) { animation-delay: 0.9s; }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .subtitle {
    font-size: 0.9rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .btn-group { display: flex; flex-direction: column; gap: 12px; width: 100%; }

  .btn {
    padding: 16px 24px;
    border: 2px solid var(--fg);
    background: var(--fg);
    color: var(--bg);
    font-family: 'Black Han Sans', sans-serif;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 1px;
  }
  .btn:hover { background: var(--accent); border-color: var(--accent); transform: translateY(-2px); }
  .btn.outline { background: transparent; color: var(--fg); }
  .btn.outline:hover { background: var(--fg); color: var(--bg); }
  .btn.small { padding: 10px 20px; font-size: 0.9rem; }

  /* ===== TUTORIAL ===== */
  #tutorial { gap: 24px; }

  .tutorial-header { text-align: center; margin-bottom: 8px; }

  .tutorial-step {
    width: 100%;
    background: var(--card);
    border: 2px solid var(--border);
    padding: 20px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  .step-num {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 2rem;
    color: var(--accent);
    line-height: 1;
    min-width: 40px;
  }

  .step-content h3 { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
  .step-content p { font-size: 0.85rem; color: var(--muted); line-height: 1.6; }

  .shapes-demo {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 8px 0;
  }

  /* ===== GAME ===== */
  #game { padding: 20px 16px; gap: 12px; }

  .game-header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .stage-info { font-family: 'Black Han Sans', sans-serif; font-size: 1.4rem; }
  .stage-sub { font-size: 0.75rem; color: var(--muted); text-align: right; }

  .progress-bar {
    width: 100%;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  .target-display {
    text-align: center;
    font-size: 0.8rem;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .target-shape-area {
    width: 100%;
    background: var(--card);
    border: 2px solid var(--border);
    padding: 16px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .target-label { font-size: 0.75rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }

  #target-shape-svg { width: 60px; height: 60px; }

  .canvas-wrap {
    width: 100%;
    position: relative;
    border: 2px solid var(--border);
    background: var(--card);
    cursor: crosshair;
    touch-action: none;
  }

  #draw-canvas { display: block; width: 100%; }

  .game-stats {
    width: 100%;
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--muted);
  }

  .count-display {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 1.1rem;
    color: var(--fg);
  }

  /* ===== RESULT / RANKING ===== */
  #result { justify-content: center; gap: 20px; text-align: center; }
  #ranking { gap: 20px; }

  .rank-list { width: 100%; display: flex; flex-direction: column; gap: 6px; }

  .rank-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--card);
    border: 2px solid var(--border);
  }
  .rank-item.top1 { border-color: #f4c542; }
  .rank-item.top2 { border-color: #b0b0b0; }
  .rank-item.top3 { border-color: #cd7f32; }

  .rank-num {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 1.3rem;
    min-width: 30px;
    color: var(--muted);
  }
  .rank-item.top1 .rank-num { color: #f4c542; }
  .rank-item.top2 .rank-num { color: #b0b0b0; }
  .rank-item.top3 .rank-num { color: #cd7f32; }

  .rank-info { flex: 1; text-align: left; }
  .rank-name { font-weight: 700; font-size: 0.95rem; }
  .rank-detail { font-size: 0.75rem; color: var(--muted); }

  .rank-stage {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 1rem;
    color: var(--accent);
  }

  .result-stage {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 4rem;
    color: var(--accent);
    line-height: 1;
  }

  .nickname-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--fg);
    background: transparent;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 1rem;
    outline: none;
    text-align: center;
  }
  .nickname-input:focus { border-color: var(--accent); }

  /* shape drawing area instructions */
  .draw-hint {
    font-size: 0.75rem;
    color: var(--muted);
    text-align: center;
    letter-spacing: 1px;
  }

  .shape-btn-row {
    display: flex;
    gap: 8px;
    width: 100%;
    justify-content: center;
  }

  .shape-thumb {
    width: 44px;
    height: 44px;
    border: 2px solid var(--border);
    background: var(--card);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .shape-thumb:hover, .shape-thumb.active {
    border-color: var(--fg);
    background: var(--fg);
  }
  .shape-thumb:hover svg path,
  .shape-thumb:hover svg circle,
  .shape-thumb:hover svg polygon,
  .shape-thumb.active svg path,
  .shape-thumb.active svg circle,
  .shape-thumb.active svg polygon {
    fill: var(--bg);
    stroke: var(--bg);
  }

  .timer-bar {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }
  .timer-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 0.1s linear;
  }

  /* similarity meter */
  .similarity {
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
  }
  .sim-value { font-family: 'Black Han Sans', sans-serif; color: var(--fg); font-size: 1rem; }

  /* flash overlay */
  .flash-overlay {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 999;
    opacity: 0;
  }
  .flash-overlay.good { background: rgba(34,197,94,0.3); animation: flashAnim 0.3s ease; }
  .flash-overlay.bad { background: rgba(230,57,70,0.3); animation: flashAnim 0.3s ease; }
  @keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

  .empty-rank {
    text-align: center;
    color: var(--muted);
    font-size: 0.9rem;
    padding: 32px;
  }

  .back-btn {
    font-size: 0.85rem;
    color: var(--muted);
    background: none;
    border: none;
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 8px;
  }
  .back-btn:hover { color: var(--fg); }
</style>
</head>
<body>

<div class="flash-overlay" id="flash"></div>

<!-- HOME -->
<div class="screen active" id="home">
  <div class="logo-shapes">
    <svg class="logo-shape" viewBox="0 0 36 36"><circle cx="18" cy="18" r="15" fill="#1a1a1a"/></svg>
    <svg class="logo-shape" viewBox="0 0 36 36"><polygon points="18,3 33,30 3,30" fill="#e63946"/></svg>
    <svg class="logo-shape" viewBox="0 0 36 36"><rect x="3" y="3" width="30" height="30" fill="#1a1a1a"/></svg>
    <svg class="logo-shape" viewBox="0 0 36 36"><polygon points="18,2 22,13 34,13 25,20 28,32 18,25 8,32 11,20 2,13 14,13" fill="#e63946"/></svg>
  </div>
  <h1>ì•¼ê°€ë‹¤</h1>
  <p class="subtitle">ë„í˜• ê·¸ë¦¬ê¸° ê²Œì„</p>
  <div class="btn-group" style="margin-top: 16px;">
    <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    <button class="btn outline" onclick="showScreen('tutorial')">íŠœí† ë¦¬ì–¼</button>
    <button class="btn outline" onclick="showRanking()">ğŸ† ë­í‚¹</button>
  </div>
  <p style="font-size:0.75rem; color:var(--muted); margin-top: 24px; text-align:center;">ìµœëŒ€ 100ë§Œ ê°œê¹Œì§€ ë„ì „!</p>
</div>

<!-- TUTORIAL -->
<div class="screen" id="tutorial">
  <div class="tutorial-header">
    <h1>ì•¼ê°€ë‹¤</h1>
    <p class="subtitle" style="margin-top:4px;">ì–´ë–»ê²Œ í•˜ëŠ” ê±°ì•¼?</p>
  </div>

  <div class="tutorial-step">
    <div class="step-num">1</div>
    <div class="step-content">
      <h3>ë„í˜•ì„ í™•ì¸í•´ìš”</h3>
      <p>ìƒë‹¨ì— ê·¸ë ¤ì•¼ í•  ë„í˜•ì´ í‘œì‹œë©ë‹ˆë‹¤. â—‹ â–³ â–¡ â˜… ì¤‘ í•˜ë‚˜ì˜ˆìš”.</p>
    </div>
  </div>

  <div class="tutorial-step">
    <div class="step-num">2</div>
    <div class="step-content">
      <h3>ë„í˜•ì„ ê·¸ë ¤ìš”</h3>
      <p>ìº”ë²„ìŠ¤ì— ì†ê°€ë½ì´ë‚˜ ë§ˆìš°ìŠ¤ë¡œ ë„í˜•ì„ ê·¸ë¦¬ì„¸ìš”. ë¹„ìŠ·í•˜ê²Œ ê·¸ë¦´ìˆ˜ë¡ ì¢‹ì•„ìš”!</p>
      <div class="shapes-demo" style="margin-top:10px;">
        <svg width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="16" fill="none" stroke="#1a1a1a" stroke-width="3"/></svg>
        <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,4 36,34 4,34" fill="none" stroke="#e63946" stroke-width="3"/></svg>
        <svg width="40" height="40" viewBox="0 0 40 40"><rect x="4" y="4" width="32" height="32" fill="none" stroke="#1a1a1a" stroke-width="3"/></svg>
        <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,2 24,14 37,14 27,22 31,35 20,27 9,35 13,22 3,14 16,14" fill="none" stroke="#e63946" stroke-width="3"/></svg>
      </div>
    </div>
  </div>

  <div class="tutorial-step">
    <div class="step-num">3</div>
    <div class="step-content">
      <h3>ë‹¨ê³„ê°€ ì˜¬ë¼ê°€ìš”</h3>
      <p>ê·¸ë¦´ìˆ˜ë¡ ëª©í‘œ ê°œìˆ˜ê°€ ëŠ˜ì–´ë‚©ë‹ˆë‹¤. 3ê°œ â†’ 5ê°œ â†’ 10ê°œ... 100ë§Œ ê°œê¹Œì§€!</p>
    </div>
  </div>

  <div class="tutorial-step">
    <div class="step-num">4</div>
    <div class="step-content">
      <h3>ë­í‚¹ì— ë„ì „í•´ìš”</h3>
      <p>ì–¼ë§ˆë‚˜ ë§ì´ ê·¸ë ¸ëŠ”ì§€ ì „ì²´ ë­í‚¹ì— ê¸°ë¡í•  ìˆ˜ ìˆì–´ìš”!</p>
    </div>
  </div>

  <div class="btn-group" style="margin-top:8px;">
    <button class="btn" onclick="startGame()">ë°”ë¡œ ì‹œì‘!</button>
    <button class="btn outline" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <div class="game-header">
    <div>
      <div class="stage-info">STAGE <span id="stage-num">1</span></div>
      <div style="font-size:0.75rem; color:var(--muted);">ëª©í‘œ: <span id="target-count">3</span>ê°œ</div>
    </div>
    <div style="text-align:right;">
      <div class="count-display"><span id="done-count">0</span> / <span id="need-count">3</span></div>
      <div class="stage-sub">ê·¸ë¦° ê°œìˆ˜</div>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progress-fill" style="width:0%"></div>
  </div>

  <div class="target-shape-area">
    <div class="target-label">ì§€ê¸ˆ ê·¸ë ¤ì•¼ í•  ë„í˜•</div>
    <svg id="target-shape-svg" viewBox="0 0 60 60"></svg>
    <div id="shape-name" style="font-size:0.8rem; color:var(--muted);"></div>
  </div>

  <div class="draw-hint">ì•„ë˜ì— ë„í˜•ì„ ê·¸ë¦¬ì„¸ìš” â†“</div>

  <div class="canvas-wrap" id="canvas-wrap">
    <canvas id="draw-canvas" height="280"></canvas>
  </div>

  <div class="game-stats">
    <div>ìœ ì‚¬ë„: <span class="sim-value" id="sim-val">â€“</span></div>
    <div>í†µê³¼: <span style="font-family:'Black Han Sans';font-size:1rem;" id="pass-count">0</span></div>
  </div>

  <div class="btn-group">
    <button class="btn small outline" onclick="clearCanvas()">ë‹¤ì‹œ ê·¸ë¦¬ê¸°</button>
    <button class="btn small" onclick="submitDrawing()">ì œì¶œ âœ“</button>
  </div>

  <button class="back-btn" onclick="confirmQuit()">ê·¸ë§Œí•˜ê¸°</button>
</div>

<!-- RESULT -->
<div class="screen" id="result">
  <p class="subtitle">ê²Œì„ ì¢…ë£Œ</p>
  <h1>ì•¼ê°€ë‹¤</h1>
  <div style="margin:16px 0;">
    <div style="font-size:0.85rem; color:var(--muted);">ë„ë‹¬í•œ ìŠ¤í…Œì´ì§€</div>
    <div class="result-stage" id="result-stage">â€“</div>
    <div style="font-size:0.85rem; color:var(--muted); margin-top:8px;">ì´ ê·¸ë¦° ê°œìˆ˜: <span id="result-total" style="font-weight:700;">0</span>ê°œ</div>
  </div>
  <p style="font-size:0.85rem; color:var(--muted);">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ë­í‚¹ì— ë“±ë¡í•˜ì„¸ìš”!</p>
  <input class="nickname-input" id="nickname-input" type="text" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ì)" maxlength="8">
  <div class="btn-group">
    <button class="btn" onclick="saveRanking()">ğŸ† ë­í‚¹ ë“±ë¡</button>
    <button class="btn outline" onclick="showScreen('home')">í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<!-- RANKING -->
<div class="screen" id="ranking">
  <h1>ì•¼ê°€ë‹¤</h1>
  <p class="subtitle" style="margin-top:4px;">ëª…ì˜ˆì˜ ì „ë‹¹</p>
  <div class="rank-list" id="rank-list">
    <div class="empty-rank">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.<br>ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”!</div>
  </div>
  <div class="btn-group" style="margin-top:8px;">
    <button class="btn" onclick="startGame()">ë„ì „í•˜ê¸°</button>
    <button class="btn outline" onclick="showScreen('home')">í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<script>
// ===== STATE =====
const SHAPES = ['circle', 'triangle', 'rect', 'star'];
const SHAPE_NAMES = { circle: 'ë™ê·¸ë¼ë¯¸', triangle: 'ì„¸ëª¨', rect: 'ë„¤ëª¨', star: 'ë³„' };

// Stage targets: how many shapes to draw per stage
function getTargetForStage(stage) {
  // Stage 1: 3, then grows
  const targets = [3,5,8,10,15,20,30,50,80,100,150,200,300,500,800,1000,2000,5000,10000,50000,100000,500000,1000000];
  return targets[Math.min(stage - 1, targets.length - 1)];
}

let currentStage = 1;
let currentShape = 'circle';
let doneCount = 0;
let totalDrawn = 0;
let targetCount = 3;
let isDrawing = false;
let points = [];
let passCount = 0;

// ===== SCREEN =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startGame() {
  currentStage = 1;
  doneCount = 0;
  totalDrawn = 0;
  passCount = 0;
  targetCount = getTargetForStage(1);
  pickShape();
  updateGameUI();
  clearCanvas();
  showScreen('game');
}

function pickShape() {
  currentShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
  renderTargetShape();
  document.getElementById('shape-name').textContent = SHAPE_NAMES[currentShape];
}

function renderTargetShape() {
  const svg = document.getElementById('target-shape-svg');
  svg.innerHTML = shapeToSVGInner(currentShape, 60);
}

function shapeToSVGInner(shape, size) {
  const s = size, h = s/2;
  if (shape === 'circle') return `<circle cx="${h}" cy="${h}" r="${h*0.75}" fill="none" stroke="#1a1a1a" stroke-width="3"/>`;
  if (shape === 'triangle') return `<polygon points="${h},${h*0.2} ${h*1.8},${h*1.8} ${h*0.2},${h*1.8}" fill="none" stroke="#e63946" stroke-width="3"/>`;
  if (shape === 'rect') return `<rect x="${h*0.2}" y="${h*0.2}" width="${h*1.6}" height="${h*1.6}" fill="none" stroke="#1a1a1a" stroke-width="3"/>`;
  if (shape === 'star') {
    const pts = starPoints(h, h, h*0.75, h*0.3, 5);
    return `<polygon points="${pts}" fill="none" stroke="#e63946" stroke-width="3"/>`;
  }
}

function starPoints(cx, cy, outerR, innerR, points) {
  let pts = [];
  for (let i = 0; i < points * 2; i++) {
    const angle = (i * Math.PI / points) - Math.PI / 2;
    const r = i % 2 === 0 ? outerR : innerR;
    pts.push(`${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`);
  }
  return pts.join(' ');
}

function updateGameUI() {
  document.getElementById('stage-num').textContent = currentStage;
  document.getElementById('target-count').textContent = targetCount.toLocaleString();
  document.getElementById('done-count').textContent = doneCount.toLocaleString();
  document.getElementById('need-count').textContent = targetCount.toLocaleString();
  document.getElementById('pass-count').textContent = passCount;
  const pct = Math.min(doneCount / targetCount * 100, 100);
  document.getElementById('progress-fill').style.width = pct + '%';
}

// ===== CANVAS =====
const canvas = document.getElementById('draw-canvas');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  const wrap = document.getElementById('canvas-wrap');
  canvas.width = wrap.clientWidth;
  canvas.height = 280;
}

function clearCanvas() {
  resizeCanvas();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  points = [];
  document.getElementById('sim-val').textContent = 'â€“';
}

function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  if (e.touches) {
    return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
  }
  return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
}

canvas.addEventListener('mousedown', e => { isDrawing = true; points = []; const p = getPos(e); points.push(p); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
canvas.addEventListener('mousemove', e => { if (!isDrawing) return; const p = getPos(e); points.push(p); ctx.lineTo(p.x, p.y); ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke(); });
canvas.addEventListener('mouseup', () => { isDrawing = false; });
canvas.addEventListener('touchstart', e => { e.preventDefault(); isDrawing = true; points = []; const p = getPos(e); points.push(p); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.beginPath(); ctx.moveTo(p.x, p.y); }, {passive:false});
canvas.addEventListener('touchmove', e => { e.preventDefault(); if (!isDrawing) return; const p = getPos(e); points.push(p); ctx.lineTo(p.x, p.y); ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke(); }, {passive:false});
canvas.addEventListener('touchend', () => { isDrawing = false; });

// ===== SIMILARITY =====
function calcSimilarity() {
  if (points.length < 5) return 0;
  
  const xs = points.map(p => p.x);
  const ys = points.map(p => p.y);
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const w = maxX - minX, h = maxY - minY;
  if (w < 10 || h < 10) return 0;

  const norm = points.map(p => ({ x: (p.x - minX) / w, y: (p.y - minY) / h }));

  if (currentShape === 'circle') return calcCircleSim(norm, w, h);
  if (currentShape === 'triangle') return calcTriangleSim(norm);
  if (currentShape === 'rect') return calcRectSim(norm);
  if (currentShape === 'star') return calcStarSim(norm);
  return 50;
}

function calcCircleSim(norm, w, h) {
  // Check aspect ratio
  const ratio = Math.min(w,h) / Math.max(w,h);
  if (ratio < 0.4) return 20;
  
  // Check if points are roughly on a circle
  const cx = 0.5, cy = 0.5;
  const dists = norm.map(p => Math.sqrt((p.x-cx)**2 + (p.y-cy)**2));
  const avgD = dists.reduce((a,b) => a+b, 0) / dists.length;
  const variance = dists.map(d => (d - avgD)**2).reduce((a,b)=>a+b,0) / dists.length;
  
  // Check if it's closed
  const start = norm[0], end = norm[norm.length-1];
  const closed = Math.sqrt((start.x-end.x)**2 + (start.y-end.y)**2) < 0.3 ? 1 : 0.6;
  
  const score = Math.max(0, 100 - variance * 500) * ratio * closed;
  return Math.min(100, Math.round(score));
}

function calcTriangleSim(norm) {
  // Find corners by sampling
  // Check: roughly 3 direction changes
  const segs = 30;
  let changes = 0;
  let lastDir = null;
  for (let i = 1; i < norm.length; i++) {
    const dx = norm[i].x - norm[i-1].x;
    const dy = norm[i].y - norm[i-1].y;
    const angle = Math.atan2(dy, dx);
    if (lastDir !== null) {
      let diff = Math.abs(angle - lastDir);
      if (diff > Math.PI) diff = 2*Math.PI - diff;
      if (diff > 0.8) changes++;
    }
    lastDir = angle;
  }
  
  const closed = (() => {
    const s = norm[0], e = norm[norm.length-1];
    return Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2) < 0.35;
  })();

  let score = 30;
  if (changes >= 2 && changes <= 6) score += 40;
  if (closed) score += 30;
  return Math.min(100, score);
}

function calcRectSim(norm) {
  // Check if points stay near edges of bounding box
  const edgeDists = norm.map(p => Math.min(p.x, 1-p.x, p.y, 1-p.y));
  const avgEdge = edgeDists.reduce((a,b)=>a+b,0) / edgeDists.length;
  const nearEdge = edgeDists.filter(d => d < 0.25).length / norm.length;
  
  const closed = (() => {
    const s = norm[0], e = norm[norm.length-1];
    return Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2) < 0.35;
  })();

  let score = Math.round(nearEdge * 70);
  if (closed) score += 30;
  return Math.min(100, score);
}

function calcStarSim(norm) {
  // Count direction reversals (spikes)
  const xs = norm.map(p=>p.x);
  const ys = norm.map(p=>p.y);
  const cx = 0.5, cy = 0.5;
  
  // Compute radial distances
  const dists = norm.map(p => Math.sqrt((p.x-cx)**2+(p.y-cy)**2));
  let peaks = 0;
  for (let i = 1; i < dists.length-1; i++) {
    if (dists[i] > dists[i-1] && dists[i] > dists[i+1] && dists[i] > 0.25) peaks++;
  }

  const closed = (() => {
    const s = norm[0], e = norm[norm.length-1];
    return Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2) < 0.4;
  })();

  let score = Math.min(peaks * 15, 70);
  if (closed) score += 30;
  return Math.min(100, score);
}

function submitDrawing() {
  if (points.length < 5) {
    flash('bad');
    return;
  }
  const sim = calcSimilarity();
  document.getElementById('sim-val').textContent = sim + '%';
  totalDrawn++;

  if (sim >= 40) {
    doneCount++;
    passCount++;
    flash('good');
  } else {
    flash('bad');
  }

  updateGameUI();
  clearCanvasKeep();

  // Check stage complete
  if (doneCount >= targetCount) {
    if (currentStage >= 23) {
      // Max!
      setTimeout(() => endGame(), 300);
    } else {
      currentStage++;
      doneCount = 0;
      targetCount = getTargetForStage(currentStage);
      pickShape();
      updateGameUI();
    }
  }
}

function clearCanvasKeep() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  points = [];
}

function flash(type) {
  const el = document.getElementById('flash');
  el.className = 'flash-overlay ' + type;
  setTimeout(() => el.className = 'flash-overlay', 400);
}

function endGame() {
  document.getElementById('result-stage').textContent = currentStage;
  document.getElementById('result-total').textContent = totalDrawn.toLocaleString();
  showScreen('result');
}

function confirmQuit() {
  if (confirm('ê²Œì„ì„ ê·¸ë§Œí• ê¹Œìš”?')) endGame();
}

// ===== RANKING (shared storage) =====
async function saveRanking() {
  const name = document.getElementById('nickname-input').value.trim();
  if (!name) { alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
  
  const entry = {
    name,
    stage: currentStage,
    total: totalDrawn,
    date: new Date().toLocaleDateString('ko-KR')
  };

  try {
    // Load existing
    let rankings = [];
    try {
      const res = await window.storage.get('yagada-rankings', true);
      if (res) rankings = JSON.parse(res.value);
    } catch(e) {}

    rankings.push(entry);
    rankings.sort((a, b) => b.stage !== a.stage ? b.stage - a.stage : b.total - a.total);
    rankings = rankings.slice(0, 50);

    await window.storage.set('yagada-rankings', JSON.stringify(rankings), true);
    alert('ğŸ† ë­í‚¹ì— ë“±ë¡ëì–´ìš”!');
    showRanking();
  } catch(e) {
    alert('ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

async function showRanking() {
  showScreen('ranking');
  const list = document.getElementById('rank-list');
  list.innerHTML = '<div class="empty-rank">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

  try {
    let rankings = [];
    try {
      const res = await window.storage.get('yagada-rankings', true);
      if (res) rankings = JSON.parse(res.value);
    } catch(e) {}

    if (rankings.length === 0) {
      list.innerHTML = '<div class="empty-rank">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.<br>ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”!</div>';
      return;
    }

    list.innerHTML = rankings.slice(0, 20).map((r, i) => {
      const cls = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
      const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : '';
      return `
        <div class="rank-item ${cls}">
          <div class="rank-num">${medal || (i+1)}</div>
          <div class="rank-info">
            <div class="rank-name">${r.name}</div>
            <div class="rank-detail">${r.date} Â· ì´ ${(r.total||0).toLocaleString()}ê°œ</div>
          </div>
          <div class="rank-stage">STAGE ${r.stage}</div>
        </div>
      `;
    }).join('');
  } catch(e) {
    list.innerHTML = '<div class="empty-rank">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”.</div>';
  }
}

// init
resizeCanvas();
window.addEventListener('resize', () => { if (document.getElementById('game').classList.contains('active')) resizeCanvas(); });
</script>
</body>
</html>
